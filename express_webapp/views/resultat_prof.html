<!DOCTYPE html>
    <!-- Page d'accueille , page où on se connecte à une session-->
    <html>
        <head>
            <meta charset="utf-8">
            <title>Resultat des élèves</title>
            <link rel="stylesheet" href="/stylesheets/eleveVsEleve.css">

            <div class ="block">
                <header class="header">
                    <img class="logo" src="/images/image.jpeg">
                       <a class="lienBoutton" href="/" ><input type = "button" value="Menu principale"></a>
                </header>
            </div>
    
        </head>
        <body>
            <h1>Resultat des élèves</h1>
            <br>
            <div >
                <form action='/resultat_prof' method='post'>
                    <input type="submit" name="action" value="Retour" >
                </form>
            </div>


            <div>
                <% if (message) { %>
                  <p style="color: red;"><%= message %></p>
                <% } %>
              </div>
            
        </body>
        <script>
            const ws = new WebSocket('ws://localhost:3001');

            new Vue({
                el: '#app',
                data: {
                    position : 1,
                    session: '<%=idSession%>',
                    parsedClassement: [],
                },
                created: function() {
                    // Écouter les événements de la connexion WebSocket
                    this.position=1;
                    const ses = this.session;
                    const sesInt = parseInt(ses);

                
                
                    ws.addEventListener('open', function(event) {

                        ws.send(JSON.stringify({ type: 'getTabEleve', session: sesInt }));
                        ws.send(JSON.stringify({ type: 'getClassement', session: sesInt }));
                    });

                    ws.addEventListener('message', function(event) {
                       
                        const data = JSON.parse(event.data);
                        if(data.type == 'classement' && data.session == sesInt ){
                            
                            const parsedClassement = [];
                            const classementObj = JSON.parse(data.data);
                            
                            Object.values(classementObj).forEach((res) => {
                                parsedClassement.push({
                                    nom: res.nom,
                                    prenom: res.prenom,
                                    points: res.points,
                                    position: this.position++,
                                });
                            });

                            parsedClassement.sort((a, b) => b.points - a.points);


                            this.parsedClassement = parsedClassement;
                            
                            }
                        
                    }.bind(this));


                },
                destroyed: function() {
                    // Fermer la connexion WebSocket lorsque la vue est détruite
                    ws.close();
                },
            });
        </script>
    </html>